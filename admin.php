<?php
session_start();

// Verificar se o usuário está logado
if (!isset($_SESSION['loggedin']) || $_SESSION['loggedin'] !== true) {
    header('Location: login.php');
        exit;
        }

        // Diretórios de uploads
        $videoDir = 'uploads/videos/';
        $imageDir = 'uploads/images/';
        $reportFile = 'reports.json';

        // Função para listar arquivos em um diretório
        function listFiles($dir, $search = null) {
            $files = is_dir($dir) ? array_diff(scandir($dir), array('.', '..')) : [];
                if ($search) {
                        $files = array_filter($files, function ($file) use ($search) {
                                    return stripos($file, $search) !== false;
                                            });
                                                }
                                                    return $files;
                                                    }

                                                    // Função para carregar denúncias
                                                    function loadReports($file, $search = null) {
                                                        $reports = file_exists($file) ? json_decode(file_get_contents($file), true) : [];
                                                            if ($search) {
                                                                    $reports = array_filter($reports, function ($report) use ($search) {
                                                                                return stripos($report['file'], $search) !== false;
                                                                                        });
                                                                                            }
                                                                                                return $reports;
                                                                                                }

                                                                                                // Função para salvar denúncias
                                                                                                function saveReports($file, $reports) {
                                                                                                    file_put_contents($file, json_encode(array_values($reports), JSON_PRETTY_PRINT));
                                                                                                    }

                                                                                                    // Receber termo de busca
                                                                                                    $searchTerm = isset($_GET['search']) ? $_GET['search'] : null;

                                                                                                    // Carregar dados filtrados
                                                                                                    $videos = listFiles($videoDir, $searchTerm);
                                                                                                    $images = listFiles($imageDir, $searchTerm);
                                                                                                    $reports = loadReports($reportFile, $searchTerm);

                                                                                                    // Ações de Exclusão
                                                                                                    if (isset($_GET['delete_video'])) {
                                                                                                        $videoToDelete = $videoDir . basename($_GET['delete_video']);
                                                                                                            if (file_exists($videoToDelete)) {
                                                                                                                    unlink($videoToDelete);
                                                                                                                            header('Location: admin.php');
                                                                                                                                    exit;
                                                                                                                                        }
                                                                                                                                        }

                                                                                                                                        if (isset($_GET['delete_image'])) {
                                                                                                                                            $imageToDelete = $imageDir . basename($_GET['delete_image']);
                                                                                                                                                if (file_exists($imageToDelete)) {
                                                                                                                                                        unlink($imageToDelete);
                                                                                                                                                                header('Location: admin.php');
                                                                                                                                                                        exit;
                                                                                                                                                                            }
                                                                                                                                                                            }

                                                                                                                                                                            if (isset($_GET['delete_report'])) {
                                                                                                                                                                                $reportId = intval($_GET['delete_report']);
                                                                                                                                                                                    if (isset($reports[$reportId])) {
                                                                                                                                                                                            unset($reports[$reportId]);
                                                                                                                                                                                                    saveReports($reportFile, $reports);
                                                                                                                                                                                                            header('Location: admin.php');
                                                                                                                                                                                                                    exit;
                                                                                                                                                                                                                        }
                                                                                                                                                                                                                        }
                                                                                                                                                                                                                        ?>
                                                                                                                                                                                                                        <!DOCTYPE html>
                                                                                                                                                                                                                        <html lang="en">
                                                                                                                                                                                                                        <head>
                                                                                                                                                                                                                          <meta charset="UTF-8">
                                                                                                                                                                                                                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                                                                                                                                                                                                                              <title>Painel Administrativo</title>
                                                                                                                                                                                                                                <!-- Bootstrap CSS -->
                                                                                                                                                                                                                                  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
                                                                                                                                                                                                                                    <style>
                                                                                                                                                                                                                                        body {
                                                                                                                                                                                                                                              background-color: #f8f9fa;
                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                      .section-title {
                                                                                                                                                                                                                                                            margin-top: 30px;
                                                                                                                                                                                                                                                                  margin-bottom: 20px;
                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                          .file-preview {
                                                                                                                                                                                                                                                                                max-width: 320px;
                                                                                                                                                                                                                                                                                      max-height: 180px;
                                                                                                                                                                                                                                                                                            object-fit: cover;
                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                    .nav-tabs .nav-link.active {
                                                                                                                                                                                                                                                                                                          background-color: #007bff;
                                                                                                                                                                                                                                                                                                                color: #fff;
                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                      </style>
                                                                                                                                                                                                                                                                                                                      </head>
                                                                                                                                                                                                                                                                                                                      <body>
                                                                                                                                                                                                                                                                                                                        <!-- Navbar -->
                                                                                                                                                                                                                                                                                                                          <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                                                                                                                                                                                                                                                                                                                              <div class="container">
                                                                                                                                                                                                                                                                                                                                    <a class="navbar-brand" href="index.php">Gerenciador de Arquivos</a>
                                                                                                                                                                                                                                                                                                                                          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                                                                                                                                                                                                                                                                                                                                                  <span class="navbar-toggler-icon"></span>
                                                                                                                                                                                                                                                                                                                                                        </button>
                                                                                                                                                                                                                                                                                                                                                              <div class="collapse navbar-collapse" id="navbarNav">
                                                                                                                                                                                                                                                                                                                                                                      <ul class="navbar-nav">
                                                                                                                                                                                                                                                                                                                                                                                <li class="nav-item"><a class="nav-link" href="index.php">Upload</a></li>
                                                                                                                                                                                                                                                                                                                                                                                          <li class="nav-item"><a class="nav-link active" href="admin.php">Administração</a></li>
                                                                                                                                                                                                                                                                                                                                                                                                  </ul>
                                                                                                                                                                                                                                                                                                                                                                                                          <a href="logout.php" class="btn btn-danger btn-sm ms-auto">Logout</a>
                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                      </nav>

                                                                                                                                                                                                                                                                                                                                                                                                                        <!-- Menu Tabs -->
                                                                                                                                                                                                                                                                                                                                                                                                                          <div class="container mt-3">
                                                                                                                                                                                                                                                                                                                                                                                                                              <ul class="nav nav-tabs" id="adminTabs" role="tablist">
                                                                                                                                                                                                                                                                                                                                                                                                                                    <li class="nav-item" role="presentation">
                                                                                                                                                                                                                                                                                                                                                                                                                                            <button class="nav-link active" id="videos-tab" data-bs-toggle="tab" data-bs-target="#videos" type="button" role="tab" aria-controls="videos" aria-selected="true">Gerenciar Vídeos</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                  </li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                        <li class="nav-item" role="presentation">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                <button class="nav-link" id="images-tab" data-bs-toggle="tab" data-bs-target="#images" type="button" role="tab" aria-controls="images" aria-selected="false">Gerenciar Imagens</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <li class="nav-item" role="presentation">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab" aria-controls="reports" aria-selected="false">Gerenciar Denúncias</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </ul>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <!-- Barra de Busca -->
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="container mt-4">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <form method="GET" class="mb-4">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <div class="input-group">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <input type="text" name="search" class="form-control" placeholder="Buscar arquivos por nome..." value="<?php echo htmlspecialchars($searchTerm); ?>">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <button type="submit" class="btn btn-primary">Buscar</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </form>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <!-- Conteúdo Principal -->
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <div class="container mt-3">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <div class="tab-content" id="adminTabsContent">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <!-- Gerenciar Vídeos -->
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <div class="tab-pane fade show active" id="videos" role="tabpanel" aria-labelledby="videos-tab">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <h2 class="section-title">Gerenciar Vídeos</h2>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <div class="list-group">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php if (count($videos) > 0): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php foreach ($videos as $video): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <div class="list-group-item d-flex justify-content-between align-items-center">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <video class="file-preview mb-2" controls>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <source src="<?php echo $videoDir . $video; ?>" type="video/mp4">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Seu navegador não suporta o elemento de vídeo.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </video>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <p class="mb-0"><?php echo htmlspecialchars($video); ?></p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <a href="?delete_video=<?php echo urlencode($video); ?>" class="btn btn-danger btn-sm">Excluir</a>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <?php endforeach; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php else: ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <p class="text-muted">Nenhum vídeo encontrado.</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <?php endif; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <!-- Gerenciar Imagens -->
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="tab-pane fade" id="images" role="tabpanel" aria-labelledby="images-tab">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <h2 class="section-title">Gerenciar Imagens</h2>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="list-group">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <?php if (count($images) > 0): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <?php foreach ($images as $image): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <img src="<?php echo $imageDir . $image; ?>" alt="<?php echo htmlspecialchars($image); ?>" class="file-preview mb-2">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <p class="mb-0"><?php echo htmlspecialchars($image); ?></p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <a href="?delete_image=<?php echo urlencode($image); ?>" class="btn btn-danger btn-sm">Excluir</a>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <?php endforeach; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php else: ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <p class="text-muted">Nenhuma imagem encontrada.</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <?php endif; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <!-- Gerenciar Denúncias -->
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <h2 class="section-title">Gerenciar Denúncias</h2>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="list-group">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <?php if (count($reports) > 0): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <?php foreach ($reports as $index => $report): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <p class="mb-1"><strong>Arquivo:</strong> <?php echo htmlspecialchars($report['file']); ?></p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <p class="mb-0"><strong>Data:</strong> <?php echo htmlspecialchars($report['date']); ?></p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <a href="?delete_report=<?php echo $index; ?>" class="btn btn-danger btn-sm">Excluir Denúncia</a>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php endforeach; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php else: ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <p class="text-muted">Nenhuma denúncia registrada.</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php endif; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <!-- Bootstrap JS -->
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </body>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </html>